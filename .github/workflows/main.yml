name: Build Quantum Stability Lab

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java (JDK 17)
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.5'
        channel: 'stable'
        
    - name: ğŸ“¦ Get Dependencies
      run: |
        flutter pub get
        echo "Dependencies installed successfully"
        
    - name: ğŸ§¹ Clean Project
      run: flutter clean
      
    - name: ğŸ”§ Fix Android Build Issues
      run: |
        echo "Fixing Android build configuration..."
        
        # 1. Gradle wrapper Ú©Ùˆ ØµØ­ÛŒØ­ ÙˆØ±Ú˜Ù† Ù¾Ø± Ù„Ø§Ø¦ÛŒÚº
        cd android
        ./gradlew wrapper --gradle-version 7.6 --distribution-type all
        cd ..
        
        # 2. Ø¢Ø¦ÛŒÚ©Ù† Ù…Ø³Ø§Ø¦Ù„ Ú©Ùˆ skip Ú©Ø±ÛŒÚº
        echo "android.enableJetifier=true" >> android/gradle.properties
        echo "android.nonTransitiveRClass=true" >> android/gradle.properties
        
        # 3. Build folder ØµØ§Ù Ú©Ø±ÛŒÚº
        rm -rf android/.gradle
        rm -rf android/build
        
    - name: ğŸ—ï¸ Build APK (No Icons Shaking)
      run: |
        echo "Building Quantum Stability Lab APK..."
        flutter build apk --release --no-tree-shake-icons --no-shrink
        echo "âœ… APK built successfully!"
        
    - name: ğŸ“Š APK Info
      run: |
        echo "=== Quantum Stability Lab APK Details ==="
        echo "ğŸ“¦ APK Path: build/app/outputs/flutter-apk/app-release.apk"
        echo "ğŸ“ File Size: $(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)"
        echo "âš›ï¸ Project: Quantum Stability Lab"
        echo "ğŸ¯ Core: 35ms Fixation Law Engine"
        
    - name: ğŸ“¤ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: quantum-stability-lab-release
        path: build/app/outputs/flutter-apk/app-release.apk
        retention-days: 7
        
    - name: ğŸ‰ Build Success
      run: |
        echo "========================================="
        echo "ğŸš€ Quantum Stability Lab Build Successful!"
        echo "========================================="
        echo "ğŸ”¬ Scientific Experiment Ready"
        echo "âš–ï¸ Quantum + Classical Stability System"
        echo "ğŸ“ˆ 35ms Fixation Law Implemented"
        echo "ğŸ¯ APK available in artifacts"
